<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√™m B·ªánh Nh√¢n M·ªõi - Hospital Management</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <div class="container">
      <!-- Header gi·ªëng index.html -->
      <header class="topbar">
        <h1>Qu·∫£n L√Ω B·ªánh Vi·ªán</h1>
        <div class="top-actions">
          <nav class="navlinks">
            <a href="index.html">üè† Trang Ch·ªß</a>
            <a href="add-patient.html" class="active" id="nav-add-patient" style="display:none">‚ûï Th√™m H·ªì S∆° B·ªánh Nh√¢n</a>
            <a href="admin-dashboard.html" id="nav-dashboard" style="display:none">üìä Dashboard</a>
            <a href="admin-users.html" id="nav-admin" style="display:none">üë• Qu·∫£n L√Ω Users</a>
          </nav>
          <div class="userbar">
            <a href="profile.html" id="profileLink" class="btn-profile" style="display:none;">
              <span class="icon">üë§</span>
              <span>H·ªì S∆°</span>
            </a>
            <span id="currentUser" class="user-info">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
            <button id="logoutBtn" class="danger" style="display:none">ƒêƒÉng Xu·∫•t</button>
          </div>
        </div>
      </header>

  <div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1 style="color: white; margin: 0 0 0.5rem 0; font-size: 2rem;">‚ûï Th√™m H·ªì S∆° B·ªánh Nh√¢n M·ªõi</h1>
          <p style="color: rgba(255,255,255,0.9); margin: 0;">Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·ªánh nh√¢n v√†o h·ªá th·ªëng</p>
        </div>
        <button onclick="window.location.href='index.html'" class="btn-icon secondary" style="background: white; color: #667eea;">
          ‚Üê Quay L·∫°i
        </button>
      </div>
    </div>

    <!-- Form Container -->
    <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
      <form id="createForm" class="modern-form">
        
        <!-- Section 1: Th√¥ng Tin C∆° B·∫£n -->
        <div class="form-section">
          <h3 class="section-title">
            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              üìã Th√¥ng Tin C∆° B·∫£n
            </span>
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="name">H·ªç v√† T√™n <span class="required">*</span></label>
              <input id="name" name="name" placeholder="Nguy·ªÖn VƒÉn A" required />
            </div>
            <div class="form-group">
              <label for="dob">Ng√†y Sinh <span class="required">*</span></label>
              <input id="dob" name="dob" type="date" required />
            </div>
            <div class="form-group">
              <label for="gender">Gi·ªõi T√≠nh</label>
              <select id="gender" name="gender">
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="phone">S·ªë ƒêi·ªán Tho·∫°i <span class="required">*</span></label>
              <input id="phone" name="phone" type="tel" placeholder="0912 345 678" required />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" placeholder="example@email.com" />
            </div>
            <div class="form-group">
              <label for="idCard">CCCD/CMND</label>
              <input id="idCard" name="id_card" placeholder="001234567890" maxlength="12" />
            </div>
          </div>

          <div class="form-group">
            <label for="address">ƒê·ªãa Ch·ªâ Th∆∞·ªùng Tr√∫</label>
            <input id="address" name="address" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë" />
          </div>
        </div>

        <!-- Section 2: Th√¥ng Tin Y T·∫ø -->
        <div class="form-section">
          <h3 class="section-title">
            <span style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              ü©∫ Th√¥ng Tin Y T·∫ø
            </span>
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="bloodType">Nh√≥m M√°u</label>
              <select id="bloodType" name="blood_type">
                <option value="">-- Ch·ªçn nh√≥m m√°u --</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="AB">AB</option>
                <option value="O">O</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="form-group">
              <label for="occupation">Ngh·ªÅ Nghi·ªáp</label>
              <input id="occupation" name="occupation" placeholder="Gi√°o vi√™n, k·ªπ s∆∞, b√°c sƒ©..." />
            </div>
            <div class="form-group">
              <label for="maritalStatus">T√¨nh Tr·∫°ng H√¥n Nh√¢n</label>
              <select id="maritalStatus" name="marital_status">
                <option value="">-- Ch·ªçn --</option>
                <option value="ƒê·ªôc th√¢n">ƒê·ªôc th√¢n</option>
                <option value="ƒê√£ k·∫øt h√¥n">ƒê√£ k·∫øt h√¥n</option>
                <option value="Ly h√¥n">Ly h√¥n</option>
                <option value="G√≥a">G√≥a</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="allergies">D·ªã ·ª®ng Thu·ªëc/Th·ª±c Ph·∫©m</label>
            <textarea id="allergies" name="allergies" rows="2" placeholder="VD: Penicillin, h·∫£i s·∫£n, ph·∫•n hoa, latex..."></textarea>
          </div>

          <div class="form-group">
            <label for="medicalHistory">Ti·ªÅn S·ª≠ B·ªánh</label>
            <textarea id="medicalHistory" name="medical_history" rows="2" placeholder="VD: Ti·ªÉu ƒë∆∞·ªùng, cao huy·∫øt √°p, hen suy·ªÖn, b·ªánh tim..."></textarea>
          </div>

          <div class="form-group">
            <label for="currentMedications">Thu·ªëc ƒêang S·ª≠ D·ª•ng</label>
            <textarea id="currentMedications" name="current_medications" rows="2" placeholder="Li·ªát k√™ c√°c lo·∫°i thu·ªëc ƒëang d√πng th∆∞·ªùng xuy√™n v√† li·ªÅu l∆∞·ª£ng..."></textarea>
          </div>
        </div>

        <!-- Section 3: Li√™n H·ªá Kh·∫©n C·∫•p -->
        <div class="form-section">
          <h3 class="section-title">
            <span style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              üö® Li√™n H·ªá Kh·∫©n C·∫•p
            </span>
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="emergencyContact">T√™n Ng∆∞·ªùi Li√™n H·ªá</label>
              <input id="emergencyContact" name="emergency_contact_name" placeholder="H·ªç t√™n ng∆∞·ªùi th√¢n" />
            </div>
            <div class="form-group">
              <label for="emergencyPhone">S·ªë ƒêi·ªán Tho·∫°i</label>
              <input id="emergencyPhone" name="emergency_contact_phone" type="tel" placeholder="0987 654 321" />
            </div>
            <div class="form-group">
              <label for="emergencyRelation">M·ªëi Quan H·ªá</label>
              <input id="emergencyRelation" name="emergency_contact_relation" placeholder="V·ª£/ch·ªìng, con, anh/ch·ªã/em..." />
            </div>
          </div>
        </div>

        <!-- Section 4: B·∫£o Hi·ªÉm Y T·∫ø -->
        <div class="form-section">
          <h3 class="section-title">
            <span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              üí≥ B·∫£o Hi·ªÉm Y T·∫ø
            </span>
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="insuranceProvider">ƒê∆°n V·ªã B·∫£o Hi·ªÉm</label>
              <input id="insuranceProvider" name="insurance_provider" placeholder="BHYT, B·∫£o Vi·ªát, Prudential..." />
            </div>
            <div class="form-group">
              <label for="insuranceNumber">S·ªë Th·∫ª BHYT</label>
              <input id="insuranceNumber" name="insurance_policy_number" placeholder="HS1234567890123" maxlength="15" />
            </div>
            <div class="form-group">
              <label for="insuranceExpiry">Ng√†y H·∫øt H·∫°n</label>
              <input id="insuranceExpiry" name="insurance_expiry_date" type="date" />
            </div>
          </div>
        </div>

        <!-- Section 5: Ghi Ch√∫ -->
        <div class="form-section">
          <h3 class="section-title">
            <span style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
              üìù Ghi Ch√∫ B·ªï Sung
            </span>
          </h3>
          
          <div class="form-group">
            <label for="notes">Th√¥ng Tin Kh√°c</label>
            <textarea id="notes" name="notes" rows="3" placeholder="C√°c th√¥ng tin b·ªï sung kh√°c v·ªÅ b·ªánh nh√¢n..."></textarea>
          </div>
        </div>

        <!-- Submit Button -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
          <button type="button" onclick="window.location.href='index.html'" class="btn-submit secondary">
            ‚ùå H·ªßy B·ªè
          </button>
          <button type="submit" class="btn-submit success">
            ‚úÖ Th√™m B·ªánh Nh√¢n V√†o H·ªá Th·ªëng
          </button>
        </div>
      </form>
      
      <div id="createResult" class="result-message"></div>
    </div>
  </div>
    </div>
  </div>

  <script type="module">
    import { getToken, getRole, clearAuth } from './auth.js';
    import { createPatient } from './api.js';

    // Check authentication
    const token = getToken();
    const role = getRole();
    
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check authorization (only admin and doctor can add patients)
    if (role !== 'admin' && role !== 'doctor') {
      alert('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m b·ªánh nh√¢n!');
      window.location.href = 'index.html';
    }

    // Display user info
    const currentUser = document.getElementById('currentUser');
    if (currentUser) {
      const roleText = {
        'admin': 'üîë Qu·∫£n tr·ªã vi√™n',
        'doctor': 'üë®‚Äç‚öïÔ∏è B√°c sƒ©',
        'user': 'üë§ B·ªánh nh√¢n'
      };
      currentUser.textContent = roleText[role] || 'Ng∆∞·ªùi d√πng';
    }

    // Show profile link
    const profileLink = document.getElementById('profileLink');
    if (profileLink) profileLink.style.display = 'inline-block';

    // Logout handler
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.style.display = 'inline-block';
      logoutBtn.addEventListener('click', () => {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
          clearAuth();
          window.location.href = 'login.html';
        }
      });
    }

    // Form submission
    const form = document.getElementById('createForm');
    const resultDiv = document.getElementById('createResult');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const payload = {};
      
      // Convert FormData to object
      for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
          payload[key] = value.trim();
        }
      }

      try {
        resultDiv.innerHTML = '<p style="color: #3b82f6;">‚è≥ ƒêang x·ª≠ l√Ω...</p>';
        
        const result = await createPatient(payload);
        
        if (result.error) {
          resultDiv.innerHTML = `<p style="color: #ef4444;">‚ùå ${result.error}</p>`;
        } else {
          resultDiv.innerHTML = '<p style="color: #10b981;">‚úÖ Th√™m b·ªánh nh√¢n th√†nh c√¥ng!</p>';
          form.reset();
          
          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        }
      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = '<p style="color: #ef4444;">‚ùå L·ªói khi th√™m b·ªánh nh√¢n</p>';
      }
    });
    
    // Update UI based on role
    const navAddPatient = document.getElementById('nav-add-patient');
    const navAdmin = document.getElementById('nav-admin');
    const navDashboard = document.getElementById('nav-dashboard');
    
    if (role === 'admin' || role === 'doctor') {
      if (navAddPatient) navAddPatient.style.display = 'inline-block';
      if (role === 'admin') {
        if (navAdmin) navAdmin.style.display = 'inline-block';
        if (navDashboard) navDashboard.style.display = 'inline-block';
      }
    }
  </script>
</body>
</html>

