<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Thá»‘ng KÃª - Hospital Management System</title>
  <link rel="stylesheet" href="style.css?v=3.6">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .dashboard-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    
    .dashboard-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gray-200);
    }
    
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card-big {
      background: white;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      border-left: 4px solid;
    }
    
    .stat-card-big.blue { border-color: var(--primary); }
    .stat-card-big.green { border-color: var(--success); }
    .stat-card-big.purple { border-color: var(--secondary); }
    .stat-card-big.orange { border-color: var(--warning); }
    
    .stat-card-big .icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-card-big .value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--gray-900);
      margin: 0.5rem 0;
    }
    
    .stat-card-big .label {
      color: var(--gray-600);
      font-size: 1rem;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .chart-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    
    .chart-card h3 {
      margin: 0 0 1.5rem 0;
      color: var(--gray-900);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <a href="index.html" class="back-link">â† Quay láº¡i Trang Chá»§</a>
    
    <div class="dashboard-header">
      <h1>ğŸ“Š Dashboard Thá»‘ng KÃª</h1>
      <p style="color: var(--gray-600); margin: 0;">Tá»•ng quan há»‡ thá»‘ng vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u</p>
    </div>
    
    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-card-big blue">
        <div class="icon">ğŸ‘¥</div>
        <div class="value" id="totalPatients">0</div>
        <div class="label">Tá»•ng Bá»‡nh NhÃ¢n</div>
      </div>
      <div class="stat-card-big green">
        <div class="icon">ğŸ“‹</div>
        <div class="value" id="totalRecords">0</div>
        <div class="label">Há»“ SÆ¡ Bá»‡nh Ãn</div>
      </div>
      <div class="stat-card-big purple">
        <div class="icon">ğŸ’Š</div>
        <div class="value" id="totalPrescriptions">0</div>
        <div class="label">ÄÆ¡n Thuá»‘c</div>
      </div>
      <div class="stat-card-big orange">
        <div class="icon">ğŸ”¬</div>
        <div class="value" id="totalLabs">0</div>
        <div class="label">XÃ©t Nghiá»‡m</div>
      </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Gender Distribution -->
      <div class="chart-card">
        <h3>ğŸ‘« PhÃ¢n Bá»‘ Giá»›i TÃ­nh</h3>
        <div class="chart-container">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
      
      <!-- Blood Type Distribution -->
      <div class="chart-card">
        <h3>ğŸ©¸ PhÃ¢n Bá»‘ NhÃ³m MÃ¡u</h3>
        <div class="chart-container">
          <canvas id="bloodTypeChart"></canvas>
        </div>
      </div>
      
      <!-- Age Distribution -->
      <div class="chart-card">
        <h3>ğŸ‚ PhÃ¢n Bá»‘ Äá»™ Tuá»•i</h3>
        <div class="chart-container">
          <canvas id="ageChart"></canvas>
        </div>
      </div>
      
      <!-- Medical Activity -->
      <div class="chart-card">
        <h3>ğŸ“ˆ Hoáº¡t Äá»™ng Y Táº¿</h3>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getToken } from './auth.js';
    
    let genderChart, bloodTypeChart, ageChart, activityChart;
    
    async function loadDashboardData() {
      try {
        // Load stats vá»›i authentication
        const statsRes = await fetch('http://localhost:3000/api/stats', {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const stats = await statsRes.json();
        
        document.getElementById('totalPatients').textContent = stats.patients || 0;
        document.getElementById('totalRecords').textContent = stats.records || 0;
        document.getElementById('totalPrescriptions').textContent = stats.prescriptions || 0;
        document.getElementById('totalLabs').textContent = stats.labs || 0;
        
        // Load patients for detailed analysis
        const patientsRes = await fetch('http://localhost:3000/api/patients', {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const patients = await patientsRes.json();
        
        renderCharts(patients, stats);
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('âŒ KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u dashboard. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
      }
    }
    
    function renderCharts(patients, stats) {
      // Gender Distribution
      const genderCount = patients.reduce((acc, p) => {
        acc[p.gender] = (acc[p.gender] || 0) + 1;
        return acc;
      }, {});
      
      genderChart = new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(genderCount),
          datasets: [{
            data: Object.values(genderCount),
            backgroundColor: ['#3b82f6', '#ec4899', '#8b5cf6'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
      
      // Blood Type Distribution
      const bloodTypeCount = patients.reduce((acc, p) => {
        const type = p.blood_type || 'ChÆ°a cÃ³';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});
      
      bloodTypeChart = new Chart(document.getElementById('bloodTypeChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(bloodTypeCount),
          datasets: [{
            data: Object.values(bloodTypeCount),
            backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#06b6d4', '#8b5cf6'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
      
      // Age Distribution
      const ageRanges = { '0-18': 0, '19-35': 0, '36-50': 0, '51-65': 0, '65+': 0 };
      patients.forEach(p => {
        if (!p.dob) return;
        const age = new Date().getFullYear() - new Date(p.dob).getFullYear();
        if (age <= 18) ageRanges['0-18']++;
        else if (age <= 35) ageRanges['19-35']++;
        else if (age <= 50) ageRanges['36-50']++;
        else if (age <= 65) ageRanges['51-65']++;
        else ageRanges['65+']++;
      });
      
      ageChart = new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(ageRanges),
          datasets: [{
            label: 'Sá»‘ bá»‡nh nhÃ¢n',
            data: Object.values(ageRanges),
            backgroundColor: '#3b82f6',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
      
      // Medical Activity
      activityChart = new Chart(document.getElementById('activityChart'), {
        type: 'bar',
        data: {
          labels: ['Há»“ SÆ¡', 'ÄÆ¡n Thuá»‘c', 'XÃ©t Nghiá»‡m'],
          datasets: [{
            label: 'Tá»•ng sá»‘',
            data: [stats.records || 0, stats.prescriptions || 0, stats.labs || 0],
            backgroundColor: ['#10b981', '#8b5cf6', '#f59e0b'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    
    // Load data on page load
    loadDashboardData();
  </script>
</body>
</html>
