<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Đăng Nhập - Hệ Thống Quản Lý Bệnh Viện</title>
    <link rel="stylesheet" href="style.css?v=3.1" />
  </head>
  <body>
    <div class="auth-page">
      <div class="auth-container">
        <div class="auth-header">
          <div class="auth-logo">🏥</div>
          <h1>Đăng Nhập</h1>
          <p>Đăng nhập vào Hệ thống Quản lý Bệnh viện</p>
        </div>

        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label for="loginUsername">👤 Tên Đăng Nhập</label>
            <input 
              id="loginUsername" 
              type="text"
              placeholder="Nhập tên đăng nhập" 
              required 
              autocomplete="username"
            />
          </div>

          <div class="form-group">
            <label for="loginPassword">🔒 Mật Khẩu</label>
            <input 
              id="loginPassword" 
              type="password"
              placeholder="Nhập mật khẩu" 
              required 
              autocomplete="current-password"
            />
          </div>

          <div class="form-options">
            <label class="checkbox-label">
              <input type="checkbox" id="rememberMe" />
              <span>Ghi nhớ đăng nhập</span>
            </label>
            <a href="forgot-password.html" class="forgot-link">Quên mật khẩu?</a>
          </div>

          <button type="submit" class="btn-auth primary">
            🔐 Đăng Nhập
          </button>

          <div id="authResult" class="result-message"></div>
        </form>

        <div class="auth-footer">
          <p>Chưa có tài khoản? <a href="register.html" class="link-primary">Đăng ký ngay</a></p>
          <a href="index.html" class="link-secondary">← Quay lại Trang chủ</a>
        </div>
      </div>

      <div class="auth-illustration">
        <div class="illustration-content">
          <h2>🏥 Quản lý Bệnh viện Thông minh</h2>
          <p>✅ Quản lý hồ sơ bệnh nhân toàn diện</p>
          <p>✅ Theo dõi đơn thuốc và kê đơn</p>
          <p>✅ Kết quả xét nghiệm tức thời</p>
          <p>✅ Báo cáo thống kê chi tiết</p>
        </div>
      </div>
    </div>

    <script type="module">
      import { loginUser } from './api.js';
      import { saveAuth } from './auth.js';

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const resultDiv = document.getElementById('authResult');
        
        console.log('🔐 Attempting login:', { username, password: '***' });
        
        resultDiv.textContent = 'Đang đăng nhập...';
        resultDiv.className = 'result-message info-message';
        resultDiv.style.display = 'block';
        
        try {
          console.log('📡 Calling loginUser API...');
          const data = await loginUser(username, password);
          console.log('📥 Response:', data);
          
          if (data.token) {
            console.log('✅ Login successful!');
            saveAuth(data.token, data.user);
            resultDiv.textContent = '✅ Đăng nhập thành công! Đang chuyển hướng...';
            resultDiv.className = 'result-message success-message';
            
            setTimeout(() => {
              console.log('🔄 Redirecting...');
              // Redirect patient users to profile page
              if (data.user.role === 'user') {
                window.location.href = 'profile.html';
              } else {
                window.location.href = 'index.html';
              }
            }, 1000);
          } else {
            console.error('❌ No token in response:', data);
            resultDiv.textContent = '❌ Đăng nhập thất bại: ' + (data.error || 'Sai tên đăng nhập hoặc mật khẩu');
            resultDiv.className = 'result-message error-message';
          }
        } catch (error) {
          console.error('❌ Login error:', error);
          resultDiv.textContent = '❌ Lỗi: ' + (error.message || 'Không thể kết nối đến máy chủ. Kiểm tra backend có chạy không.');
          resultDiv.className = 'result-message error-message';
        }
      });
      
      console.log('✅ Login page loaded');
    </script>
  </body>
</html>
