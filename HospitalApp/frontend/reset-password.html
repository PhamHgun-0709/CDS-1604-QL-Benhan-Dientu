<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u - Hospital Management System</title>
  <link rel="stylesheet" href="style.css?v=3.5">
  <style>
    .reset-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.95rem;
      display: none;
    }
    .reset-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
      display: block;
    }
    .reset-message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
      display: block;
    }
    .password-strength {
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    .password-strength .bar {
      height: 4px;
      border-radius: 2px;
      background: var(--gray-200);
      margin: 0.5rem 0;
      overflow: hidden;
    }
    .password-strength .bar-fill {
      height: 100%;
      transition: width 0.3s, background 0.3s;
    }
    .password-strength .bar-fill.weak { width: 33%; background: var(--danger); }
    .password-strength .bar-fill.medium { width: 66%; background: var(--warning); }
    .password-strength .bar-fill.strong { width: 100%; background: var(--success); }
  </style>
</head>
<body>
  <div class="auth-page">
    <div class="auth-container">
      <div class="auth-illustration">
        <h1>üîë</h1>
        <h2>ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u</h2>
        <p>Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi cho t√†i kho·∫£n c·ªßa b·∫°n.</p>
      </div>

      <div class="auth-form-container">
        <h2>T·∫°o M·∫≠t Kh·∫©u M·ªõi</h2>
        
        <form id="resetPasswordForm" class="auth-form">
          <input type="hidden" id="resetToken" name="token">
          
          <div class="form-group">
            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" id="newPassword" name="password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
            <div class="password-strength">
              <div class="bar"><div id="strengthBar" class="bar-fill"></div></div>
              <span id="strengthText"></span>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u...">
          </div>

          <button type="submit" class="btn-primary btn-full">‚úÖ ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u</button>
        </form>

        <div id="resetMessage" class="reset-message"></div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('resetPasswordForm');
    const messageDiv = document.getElementById('resetMessage');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
      messageDiv.className = 'reset-message error';
      messageDiv.textContent = '‚ùå Link kh√¥i ph·ª•c kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.';
      form.style.display = 'none';
    } else {
      document.getElementById('resetToken').value = token;
    }

    // Password strength checker
    newPasswordInput.addEventListener('input', (e) => {
      const password = e.target.value;
      const strength = checkPasswordStrength(password);
      
      strengthBar.className = 'bar-fill ' + strength.class;
      strengthText.textContent = strength.text;
    });

    function checkPasswordStrength(password) {
      if (password.length === 0) {
        return { class: '', text: '' };
      }
      
      let score = 0;
      if (password.length >= 8) score++;
      if (password.length >= 12) score++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
      if (/\d/.test(password)) score++;
      if (/[^a-zA-Z0-9]/.test(password)) score++;
      
      if (score <= 2) return { class: 'weak', text: 'Y·∫øu' };
      if (score <= 4) return { class: 'medium', text: 'Trung b√¨nh' };
      return { class: 'strong', text: 'M·∫°nh' };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      // Validate
      if (password !== confirmPassword) {
        messageDiv.className = 'reset-message error';
        messageDiv.textContent = '‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
        return;
      }
      
      if (password.length < 6) {
        messageDiv.className = 'reset-message error';
        messageDiv.textContent = '‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!';
        return;
      }
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
      
      try {
        const response = await fetch('http://localhost:3000/api/users/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: token,
            password: password
          })
        });

        const result = await response.json();
        
        if (response.ok) {
          messageDiv.className = 'reset-message success';
          messageDiv.textContent = '‚úÖ ' + result.message + ' ƒêang chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p...';
          form.reset();
          
          // Redirect to login after 2 seconds
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          messageDiv.className = 'reset-message error';
          messageDiv.textContent = '‚ùå ' + (result.error || 'C√≥ l·ªói x·∫£y ra');
          submitBtn.disabled = false;
          submitBtn.textContent = '‚úÖ ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u';
        }
      } catch (error) {
        console.error('Error:', error);
        messageDiv.className = 'reset-message error';
        messageDiv.textContent = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.';
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u';
      }
    });
  </script>
</body>
</html>
